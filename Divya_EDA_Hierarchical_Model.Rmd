---
title: "Divya_EDA_Hierarchical_Model"
author: "Divya Parmar"
date: "12/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read the data and get column values.

```{r}
data <- read.csv("uk_used_cars.csv")
data<- data[!(data$year== 2060),]
data<- data[rowSums(is.na(data)) == 0,]
str(data)
```

## Price plot has a long right tail, but has a rough bell curve shape.

```{r pressure, echo=FALSE}
hist(data$price, breaks=c(seq.int(0, 200) * 1000))
```

## Idea 

Build hierarchical model on Maker and Model.

## Task

1. Drop missing values.

2. Look at quartiles of sale price by car maker to get prior.

3. Look at quartiles of sale price by car model for each car maker to get prior.

4. Create multi-level model from maker --> model --> price. 

## Look at mean of price by car maker and model. Code taken from Aziz's work. 

```{r}

library(ggplot2)

ggplot(data, aes(x=Car.Make, y=price, color=Car.Make)) +
  geom_boxplot()+
  scale_x_discrete(labels = abbreviate)+
  labs(title = "Price Box Plot Per Car Make")+
  theme_minimal()

print(mean(data$price))
print(sd(data$price))
```
## Create dataframe of mean by car-make and plot as histogram.

Goal is to get sense of distribution. Then we can fit a prior to this in the hierarchical model.

```{r}
library(dplyr)

data %>% 
  group_by(Car.Make) %>%
  summarise_at(vars(price), list(mean = mean))
```

```{r}
library(dplyr)

df_ex <- data %>% 
  group_by(Car.Make) %>%
  summarise_at(vars(price), list(mean = mean))
```

```{r}
library(dplyr)

hist(df_ex$mean, breaks=20)
```

## Look at distribution of mean price within each car maker (broken out by model).

```{r}

library(dplyr)
car_makers_unique = unique(data$Car.Make)

for (car in car_makers_unique) {
  subset_car <- subset(data, data$Car.Make == car)
  
  df_sub <- subset_car %>%
    group_by(model) %>%
    summarise_at(vars(price), list(mean = mean))

  hist(df_sub$mean, breaks=10, main = paste("Mean sale price by model of", car))  
}

```


## Next steps - identify priors for hierarchical model.

``` {r}

print(nrow(data))
print(length(unique(data$model)))
print(length(unique(data$Car.Make)))

```



``` {r}

# Need rjags to build model
# One helpful link:
# https://stats.stackexchange.com/questions/185254/multi-level-bayesian-hierarchical-regression-using-rjags

N <- nrow(data)

# Factor variables for hierarchical priors
carmaker <- as.factor(data$Car.Make)
carmodel <- as.factor(data$model)

# Variables for model definition
Ncarmaker <- nlevels(as.factor(data$Car.Make))
Ncarmodel <- nlevels(as.factor(data$model))

# Lookup table of carmaker to car model - groupby carmaker and carmodel to get 195 obs
maker_model <- data.frame(carmaker, carmodel)
maker_model <- unique(maker_model)
maker_model <- maker_model$carmaker

# Covariates
y <- data$price
x1 <- data$mileage
x2 <- data$mpg

```


``` {r}

modelstring = "
  model {
    for (i in 1:N) {
      #y[i] ~ dnorm(yhat[i], tau)
      #yhat <- b0[carmodel[i]] + b1[carmodel[i]] * x1[i] + b2[carmodel[i]] * x2[i]
      
      y[i] ~ dnorm(b0[carmodel[i]] + b1[carmodel[i]] * x1[i] + b2[carmodel[i]] * x2[i], tau)
    }
    
    for (m in 1:Ncarmodel) {
      b0[m] ~ dnorm(c0[makermodel[m]], b0t) 
      b1[m] ~ dnorm(c1[makermodel[m]], b1t) 
      b2[m] ~ dnorm(c2[makermodel[m]], b2t) 
    }
    
    for (c in 1:Ncarmaker) {
      c0[c] ~ dnorm(d0, c0t)
      c1[c] ~ dnorm(d1, c1t)
      c2[c] ~ dnorm(d2, c2t)
    }
  
  b0t ~ dgamma(0.001, 0.001)
  b1t ~ dgamma(0.001, 0.001)
  b2t ~ dgamma(0.001, 0.001)
  
  c0t ~ dgamma(0.001, 0.001)
  c1t ~ dgamma(0.001, 0.001)
  c2t ~ dgamma(0.001, 0.001)
  
  d0 ~ dnorm(0, 0.0001)
  d1 ~ dnorm(0, 0.0001)
  d2 ~ dnorm(0, 0.0001)
  
  tau ~ dgamma(0.001, 0.001)
  
  }
"

writeLines(modelstring, con="model_hier_dp.txt")

```

```{r}

library(rjags)

jagsModel <- jags.model('model_hier_dp.txt',
                   data = list('x1' = x1,
                               'x2' = x2,
                               'y' = y,
                               'N' = N,
                               'Ncarmodel' = Ncarmodel,
                               'Ncarmaker' = Ncarmaker,
                               #'carmaker' = carmaker,
                               'carmodel' = carmodel,
                               'makermodel' = maker_model),
                   n.chains = 4,
                   n.adapt = 100)


```

```{r}

update(jagsModel, n.iter=100)

jags_sim <- jags.samples(model=jagsModel, variable.names = c("b0", "b1", "b2"), n.iter = 1000)
```

```{r}

summary(jags_sim)


```

```{r}

str(jags_sim)

```

```{r}

posterior_means <- lapply(jags_sim, apply, 1, "mean")

# Going to use median instead of mean for parameters that go into prediction
#b0_pred <- mean(posterior_means$b0)
#b1_pred <- mean(posterior_means$b1)
#b2_pred <- mean(posterior_means$b2)


```

```{r}

b0_pred <- median(posterior_means$b0)
b1_pred <- median(posterior_means$b1)
b2_pred <- median(posterior_means$b2)


```

```{r}

hist(posterior_means$b0, breaks=50, xlab = "b0 bin", ylab = "Occurances in MCMC chain", main = "MCMC values of b0")


```

```{r}

hist(posterior_means$b1, breaks=50, xlab = "b1 bin", ylab = "Occurances in MCMC chain", main = "MCMC values of b1")


```

```{r}

hist(posterior_means$b2, breaks=50, xlab = "b2 bin", ylab = "Occurances in MCMC chain", main = "MCMC values of b2")


```

```{r}

y_pred <- b0_pred + b1_pred * x1 + b2_pred * x2

mse = mean((y - y_pred) ^ 2)


mse
mse ^ 0.5

```